
<!DOCTYPE html>
<html lang="zh-CN">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="loannes&#39;s blog">
    <title>SDWebImage源码分析 - loannes&#39;s blog</title>
    <meta name="author" content="loannes">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"loannes","sameAs":["https://github.com/","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/","https://plus.google.com/","https://www.linkedin.com/profile/","mailto"]},"articleBody":"==================\n###前言\n使用SDWebImage这个第三方开源库也有一段时间了，一直没有机会去深入理解这个库为何如此强大。这次本着冒险的精神花了点时间去里面探索了一番。虽然过程有点痛苦结果也是弄的自己灰头土脸的，不过起码还是有收获的。所以在本blog做一次第一次探险的记录吧。\n\nSDWebImage github地址\n原文是这么说的：SDWebImage是一个图片的异步下载器并且支持缓存。作者是 KonstantinosK.,目前star数已超过1.3w。目前有很多著名的app都在使用这个库，如携程，Facebook等。虽然它的主要功能就这2点，但是它无可厚非的成为了目前主流的iOS第三方开源库的王者之一。\n下面来看一下SDWebImage的类关系图\nPS: 图片来自于 http://www.jianshu.com/p/c07df06c60be\n\n自从更新iOS5.0之后，NSURLCache这个类已成为处理内存或者硬盘存储源数据的必需品。但是当你将原始缓存数据转换成UIImage的时候，这个举动其实是很浪费资源的，包括数据处理和内存拷贝等。而SDWebImage就是为了解决这个问题而诞生的，SDWebImage会缓存UIimage的描述到内存中，并把经过压缩过的图片放到磁盘中（或者内存中），这样大大减小了在频繁从内存中获取图片的性能开销。然后关于SDWebImage的压缩方式也很人性化的使用了后台线程的方式，避免了线程阻塞的问题。\n参考文章：https://github.com/rs/SDWebImage/wiki/How-is-SDWebImage-better-than-X%3F\n以上2点是SDWebImage的优势所在，接下来为了论证它的这些特点我们详细分析下它的源码：\n\nSDWebImage 在缓存中进行写的操作是异步执行的，所以不会对UI造成延迟\nSDWebImage 会在后台解压缩图片\n异步下载图片，不会阻塞线程\n良好的缓存管理\n支持arm64位系统\n\n先来看一下SDWebImageDownloader，在SDWebImageDownloader类中\n- (id &lt;SDWebImageOperation&gt;)downloadImageWithURL:(NSURL *)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock\n该接口中这么写到\n\nIn order to prevent from potential duplicate caching (NSURLCache +SDImageCache) we disable the cache for image requests if toldotherwise\n\n它为了不与SDImageCache类产生冲突造成重复缓存，所以在请求的时候并没有做图片的存储工作。它把下载图片和缓存全部都交由SDWebImageManager来管理了。\n然后关于URL的缓存策略不出乎意料的还是就常见的2中方式NSURLRequestUseProtocolCachePolicy默认的缓存策略，如果缓存不存在，直接从服务端获取。如果缓存存在，会根据response中的Cache-Control字段判断下一步操作，如:Cache-Control字段为must-revalidata,则询问服务端该数据是否有更新，无更新的话直接返回给用户缓存数据，若已更新，则请求服务端.NSURLRequestReloadIgnoringLocalCacheData :忽略本地缓存，直接向服务器请求数据。\n- (id &lt;SDWebImageOperation&gt;)downloadImageWithURL:(NSURL*)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock {\n__block SDWebImageDownloaderOperation *operation;\n__weak __typeof(self)wself = self;\n\n[self addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^{\n    NSTimeInterval timeoutInterval = wself.downloadTimeout;\n    if (timeoutInterval == 0.0) {\n        timeoutInterval = 15.0;\n    }\n\n    // In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise\n    NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ? NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData) timeoutInterval:timeoutInterval];\n    request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);\n    request.HTTPShouldUsePipelining = YES;\n    if (wself.headersFilter) {\n        request.allHTTPHeaderFields = wself.headersFilter(url, [wself.HTTPHeaders copy]);\n    }\n    else {\n        request.allHTTPHeaderFields = wself.HTTPHeaders;\n    }\n    operation = [[wself.operationClass alloc] initWithRequest:request\n                                                      options:options\n                                                     progress:^(NSInteger receivedSize, NSInteger expectedSize) {\n                                                         SDWebImageDownloader *sself = wself;\n                                                         if (!sself) return;\n                                                         __block NSArray *callbacksForURL;\n                                                         dispatch_sync(sself.barrierQueue, ^{\n                                                             callbacksForURL = [sself.URLCallbacks[url] copy];\n                                                         });\n                                                         for (NSDictionary *callbacks in callbacksForURL) {\n                                                             dispatch_async(dispatch_get_main_queue(), ^{\n                                                                 SDWebImageDownloaderProgressBlock callback = callbacks[kProgressCallbackKey];\n                                                                 if (callback) callback(receivedSize, expectedSize);\n                                                             });\n                                                         }\n                                                     }\n                                                    completed:^(UIImage *image, NSData *data, NSError *error, BOOL finished) {\n                                                        SDWebImageDownloader *sself = wself;\n                                                        if (!sself) return;\n                                                        __block NSArray *callbacksForURL;\n                                                        dispatch_barrier_sync(sself.barrierQueue, ^{\n                                                            callbacksForURL = [sself.URLCallbacks[url] copy];\n                                                            if (finished) {\n                                                                [sself.URLCallbacks removeObjectForKey:url];\n                                                            }\n                                                        });\n                                                        for (NSDictionary *callbacks in callbacksForURL) {\n                                                            SDWebImageDownloaderCompletedBlock callback = callbacks[kCompletedCallbackKey];\n                                                            if (callback) callback(image, data, error, finished);\n                                                        }\n                                                    }\n                                                    cancelled:^{\n                                                        SDWebImageDownloader *sself = wself;\n                                                        if (!sself) return;\n                                                        dispatch_barrier_async(sself.barrierQueue, ^{\n                                                            [sself.URLCallbacks removeObjectForKey:url];\n                                                        });\n                                                    }];\n    operation.shouldDecompressImages = wself.shouldDecompressImages;\n\n    if (wself.urlCredential) {\n        operation.credential = wself.urlCredential;\n    } else if (wself.username &amp;&amp; wself.password) {\n        operation.credential = [NSURLCredential credentialWithUser:wself.username password:wself.password persistence:NSURLCredentialPersistenceForSession];\n    }\n\n    if (options &amp; SDWebImageDownloaderHighPriority) {\n        operation.queuePriority = NSOperationQueuePriorityHigh;\n    } else if (options &amp; SDWebImageDownloaderLowPriority) {\n        operation.queuePriority = NSOperationQueuePriorityLow;\n    }\n\n    [wself.downloadQueue addOperation:operation];\n    if (wself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) {\n        // Emulate LIFO execution order by systematically adding new operations as last operation&apos;s dependency\n        [wself.lastAddedOperation addDependency:operation];\n        wself.lastAddedOperation = operation;\n    }\n}];\n\nreturn operation;\n}SDWebImageDownLoader默认的缓存策略是NSURLRequestReloadIgnoringLocalCacheData，它会把已经设置好的request交由SDWebImageDownloaderOperation处理图片方向，标记标签等，它命名的标签就是URL。最终通过block返回给SDWebImageManager做本地存储工作。直到下次加载图片的时候会通过标签进行本地搜寻直接返回图片，如果本地没有该图片就会再通过NSURLConnection请求资源。\n在上面几个步骤中有几个问题需要讲一下：\n\n为什么SDWebImage不直接使用NSURLConection自己的缓存策略，反而还另外写了个SDImageCache类。那么麻烦的事情肯定有其中的原因在。\n\n因为NSURLConection的缓存方式是把图片以data的形式存在本地的，所以SDWebImage考虑到如果频繁使用图片的情况下会花很多的资源在处理data转成UIImage对象上，所以才避开了这个缓存方式改以用SDImageCache。\n\n\n使用过程当中有什么值得注意的细节\n\n都知道压缩图片是一件很伤神伤力的事情，强大的SDWebImage也无法轻松承受多张图片同时解压缩过程，所以特地把这个过程放在了自动释放池中进行。但是在iOS7上面还是要记得通过调用[SDImageCache sharedImageCache] clearMemory]来清理缓存。详细可查看SDWebImageDecoder类。PS:它是不会对gif格式的图片进行压缩的。\n\n常用的图片格式有gif，jpg，png,tiff,bmp，webp等都是支持的。\n\n目前使用的是NSURLConnection，所以还不支持后台运行。\n\n\n\n\n大致的缓存处理过程就是这么回事，核心思路就是这些，其他辅助类都不多做解释了。\n总结结构十分清晰，该避免的一些基础性的错误都避免了，类似retaincycle，线程的管理。耗时长的请求都放在异步执行了。这个缓存策略是我以前从没想过的问题，为了追求性能的极致确实需要做到这份儿上。\n代码上面没有什么难度，大量的基础知识非常适合中级iOS程序员做提升自己的训练课程，以上。\n","dateCreated":"2016-03-18T11:12:19+08:00","dateModified":"2019-12-12T23:40:42+08:00","datePublished":"2016-03-18T11:12:19+08:00","description":"","headline":"SDWebImage源码分析","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"/http:/yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},"publisher":{"@type":"Organization","name":"loannes","sameAs":["https://github.com/","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/","https://plus.google.com/","https://www.linkedin.com/profile/","mailto"]},"url":"/http:/yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","keywords":"iOS"}</script>
    <meta name="description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ###前言 使用SDWebImage这个第三方开源库也有一段时间了，一直没有机会去深入理解这个库为何如此强大。这次本着冒险的精神花了点时间去里面探索了一番。虽然过程有点痛苦结果也是弄的自己灰头土脸的，不过起码还是有收获的。所以在本blog做一次第一次探险的记录吧。  SDWebImage github地址 原文是这么说的：SDWebImage是一个图片的异步下">
<meta property="og:type" content="blog">
<meta property="og:title" content="SDWebImage源码分析">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2016&#x2F;03&#x2F;18&#x2F;SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90&#x2F;index.html">
<meta property="og:site_name" content="loannes&#39;s blog">
<meta property="og:description" content="&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ###前言 使用SDWebImage这个第三方开源库也有一段时间了，一直没有机会去深入理解这个库为何如此强大。这次本着冒险的精神花了点时间去里面探索了一番。虽然过程有点痛苦结果也是弄的自己灰头土脸的，不过起码还是有收获的。所以在本blog做一次第一次探险的记录吧。  SDWebImage github地址 原文是这么说的：SDWebImage是一个图片的异步下">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-03-18T03:12:19.000Z">
<meta property="article:modified_time" content="2019-12-12T15:40:42.000Z">
<meta property="article:author" content="loannes">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/all.css">

    
<link rel="stylesheet" href="/assets/css/jquery.fancybox.css">

    
<link rel="stylesheet" href="/assets/css/thumbs.css">

    
<link rel="stylesheet" href="/assets/css/tranquilpeak.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/%20"
            aria-label=""
        >
            loannes&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Öffne den Link: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/%20"
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Kategorien"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Kategorien</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archiv"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archiv</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Suche"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Suche</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="Über"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Über</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://stackoverflow.com/users" target="_blank" rel="noopener" title="Stack Overflow">
                    
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://facebook.com/" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://plus.google.com/" target="_blank" rel="noopener" title="Google Plus">
                    
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google Plus</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/profile/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/mailto"
                            title="E-Mail"
                        >
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">E-Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            SDWebImage源码分析
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2016-03-18T11:12:19+08:00">
	
		    18 3月 2016
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>==================</p>
<p>###前言</p>
<p>使用SDWebImage这个第三方开源库也有一段时间了，一直没有机会去深入理解这个库为何如此强大。这次本着冒险的精神花了点时间去里面探索了一番。虽然过程有点痛苦结果也是弄的自己灰头土脸的，不过起码还是有收获的。所以在本blog做一次第一次探险的记录吧。</p>
<hr>
<p><a href="https://github.com/rs/SDWebImage" target="_blank" rel="noopener">SDWebImage github地址</a></p>
<p>原文是这么说的：SDWebImage是一个图片的异步下载器并且支持缓存。<br>作者是 <a href="https://github.com/mythodeia" target="_blank" rel="noopener">Konstantinos<br>K.</a>,目前star数已超过1.3w。目前有很多著名的app都在使用这个库，如携程，Facebook等。<br>虽然它的主要功能就这2点，但是它无可厚非的成为了目前主流的iOS第三方开源库的王者之一。</p>
<p>下面来看一下SDWebImage的类关系图</p>
<p>PS: 图片来自于 <a href="http://www.jianshu.com/p/c07df06c60be" target="_blank" rel="noopener">http://www.jianshu.com/p/c07df06c60be</a></p>
<hr>
<p>自从更新iOS5.0之后，NSURLCache这个类已成为处理内存或者硬盘存储源数据的必需品。但是当你将原始缓存数据转换成UIImage的时候，这个举动其实是很浪费资源的，包括数据处理和内存拷贝等。<br>而SDWebImage就是为了解决这个问题而诞生的，SDWebImage会缓存UIimage的描述到内存中，并把经过压缩过的图片放到磁盘中（或者内存中），这样大大减小了在频繁从内存中获取图片的性能开销。<br>然后关于SDWebImage的压缩方式也很人性化的使用了后台线程的方式，避免了线程阻塞的问题。</p>
<p>参考文章：<a href="https://github.com/rs/SDWebImage/wiki/How-is-SDWebImage-better-than-X%3F" target="_blank" rel="noopener">https://github.com/rs/SDWebImage/wiki/How-is-SDWebImage-better-than-X%3F</a></p>
<p>以上2点是SDWebImage的优势所在，接下来为了论证它的这些特点我们详细分析下它的源码：</p>
<ol>
<li>SDWebImage 在缓存中进行写的操作是异步执行的，所以不会对UI造成延迟</li>
<li>SDWebImage 会在后台解压缩图片</li>
<li>异步下载图片，不会阻塞线程</li>
<li>良好的缓存管理</li>
<li>支持arm64位系统</li>
</ol>
<p>先来看一下SDWebImageDownloader，在SDWebImageDownloader类中</p>
<p><code>- (id &lt;SDWebImageOperation&gt;)downloadImageWithURL:(NSURL *)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock</code></p>
<p>该接口中这么写到</p>
<blockquote>
<p>In order to prevent from potential duplicate caching (NSURLCache +<br>SDImageCache) we disable the cache for image requests if told<br>otherwise</p>
</blockquote>
<p>它为了不与SDImageCache类产生冲突造成重复缓存，所以在请求的时候并没有做图片的存储工作。它把下载图片和缓存全部都交由SDWebImageManager来管理了。</p>
<dl><dt>然后关于URL的缓存策略不出乎意料的还是就常见的2中方式<code>NSURLRequestUseProtocolCachePolicy</code></dt><dd>默认的缓存策略，<br>如果缓存不存在，直接从服务端获取。如果缓存存在，会根据response中的Cache-Control字段判断下一步操作，如:<br>Cache-Control字段为must-revalidata,<br>则询问服务端该数据是否有更新，无更新的话直接返回给用户缓存数据，若已更新，则请求服务端.</dd></dl><p><code>NSURLRequestReloadIgnoringLocalCacheData</code> :<br>忽略本地缓存，直接向服务器请求数据。</p>
<pre><code>- (id &lt;SDWebImageOperation&gt;)downloadImageWithURL:(NSURL*)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock {
__block SDWebImageDownloaderOperation *operation;
__weak __typeof(self)wself = self;

[self addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^{
    NSTimeInterval timeoutInterval = wself.downloadTimeout;
    if (timeoutInterval == 0.0) {
        timeoutInterval = 15.0;
    }

    // In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise
    NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:(options &amp; SDWebImageDownloaderUseNSURLCache ? NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData) timeoutInterval:timeoutInterval];
    request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);
    request.HTTPShouldUsePipelining = YES;
    if (wself.headersFilter) {
        request.allHTTPHeaderFields = wself.headersFilter(url, [wself.HTTPHeaders copy]);
    }
    else {
        request.allHTTPHeaderFields = wself.HTTPHeaders;
    }
    operation = [[wself.operationClass alloc] initWithRequest:request
                                                      options:options
                                                     progress:^(NSInteger receivedSize, NSInteger expectedSize) {
                                                         SDWebImageDownloader *sself = wself;
                                                         if (!sself) return;
                                                         __block NSArray *callbacksForURL;
                                                         dispatch_sync(sself.barrierQueue, ^{
                                                             callbacksForURL = [sself.URLCallbacks[url] copy];
                                                         });
                                                         for (NSDictionary *callbacks in callbacksForURL) {
                                                             dispatch_async(dispatch_get_main_queue(), ^{
                                                                 SDWebImageDownloaderProgressBlock callback = callbacks[kProgressCallbackKey];
                                                                 if (callback) callback(receivedSize, expectedSize);
                                                             });
                                                         }
                                                     }
                                                    completed:^(UIImage *image, NSData *data, NSError *error, BOOL finished) {
                                                        SDWebImageDownloader *sself = wself;
                                                        if (!sself) return;
                                                        __block NSArray *callbacksForURL;
                                                        dispatch_barrier_sync(sself.barrierQueue, ^{
                                                            callbacksForURL = [sself.URLCallbacks[url] copy];
                                                            if (finished) {
                                                                [sself.URLCallbacks removeObjectForKey:url];
                                                            }
                                                        });
                                                        for (NSDictionary *callbacks in callbacksForURL) {
                                                            SDWebImageDownloaderCompletedBlock callback = callbacks[kCompletedCallbackKey];
                                                            if (callback) callback(image, data, error, finished);
                                                        }
                                                    }
                                                    cancelled:^{
                                                        SDWebImageDownloader *sself = wself;
                                                        if (!sself) return;
                                                        dispatch_barrier_async(sself.barrierQueue, ^{
                                                            [sself.URLCallbacks removeObjectForKey:url];
                                                        });
                                                    }];
    operation.shouldDecompressImages = wself.shouldDecompressImages;

    if (wself.urlCredential) {
        operation.credential = wself.urlCredential;
    } else if (wself.username &amp;&amp; wself.password) {
        operation.credential = [NSURLCredential credentialWithUser:wself.username password:wself.password persistence:NSURLCredentialPersistenceForSession];
    }

    if (options &amp; SDWebImageDownloaderHighPriority) {
        operation.queuePriority = NSOperationQueuePriorityHigh;
    } else if (options &amp; SDWebImageDownloaderLowPriority) {
        operation.queuePriority = NSOperationQueuePriorityLow;
    }

    [wself.downloadQueue addOperation:operation];
    if (wself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) {
        // Emulate LIFO execution order by systematically adding new operations as last operation&apos;s dependency
        [wself.lastAddedOperation addDependency:operation];
        wself.lastAddedOperation = operation;
    }
}];

return operation;
}</code></pre><p>SDWebImageDownLoader默认的缓存策略是<code>NSURLRequestReloadIgnoringLocalCacheData</code>，它会把已经设置好的request交由SDWebImageDownloaderOperation处理图片方向，标记标签等，它命名的标签就是URL。最终通过block返回给SDWebImageManager做本地存储工作。直到下次加载图片的时候会通过标签进行本地搜寻直接返回图片，如果本地没有该图片就会再通过NSURLConnection请求资源。</p>
<p>在上面几个步骤中有几个问题需要讲一下：</p>
<ul>
<li><p>为什么SDWebImage不直接使用NSURLConection自己的缓存策略，反而还另外写了个SDImageCache类。那么麻烦的事情肯定有其中的原因在。</p>
<ul>
<li>因为NSURLConection的缓存方式是把图片以data的形式存在本地的，所以SDWebImage考虑到如果频繁使用图片的情况下会花很多的资源在处理data转成UIImage对象上，所以才避开了这个缓存方式改以用SDImageCache。</li>
</ul>
</li>
<li><p>使用过程当中有什么值得注意的细节</p>
<ul>
<li><p>都知道压缩图片是一件很伤神伤力的事情，强大的SDWebImage也无法轻松承受多张图片同时解压缩过程，所以特地把这个过程放在了自动释放池中进行。但是在iOS7上面还是要记得通过调用<code>[SDImageCache sharedImageCache] clearMemory]</code>来清理缓存。详细可查看<code>SDWebImageDecoder</code>类。<br>PS:它是不会对gif格式的图片进行压缩的。</p>
</li>
<li><p>常用的图片格式有gif，jpg，png,tiff,bmp，webp等都是支持的。</p>
</li>
<li><p>目前使用的是NSURLConnection，所以还不支持后台运行。</p>
</li>
</ul>
</li>
</ul>
<p>大致的缓存处理过程就是这么回事，核心思路就是这些，其他辅助类都不多做解释了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>结构十分清晰，该避免的一些基础性的错误都避免了，类似retain<br>cycle，线程的管理。耗时长的请求都放在异步执行了。这个缓存策略是我以前从没想过的问题，为了追求性能的极致确实需要做到这份儿上。</p>
<p>代码上面没有什么难度，大量的基础知识非常适合中级iOS程序员做提升自己的训练课程，以上。</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">GETAGGT IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/iOS/" rel="tag">iOS</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2016/04/13/%E8%B0%88%E8%B0%88Http%E5%92%8CHttps%20/"
                    data-tooltip="谈谈Http和Https"
                    aria-label="FRÜHER: 谈谈Http和Https"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">FRÜHER</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2016/02/13/%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89UIViewController%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB/"
                    data-tooltip="创建自定义UIViewController过渡动画"
                    aria-label="NÄCHSTER: 创建自定义UIViewController过渡动画"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NÄCHSTER</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Teilen auf Facebook"
                    aria-label="Teilen auf Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Teilen auf Twitter"
                    aria-label="Teilen auf Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Teilen auf Google Plus"
                    aria-label="Teilen auf Google Plus"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 loannes. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2016/04/13/%E8%B0%88%E8%B0%88Http%E5%92%8CHttps%20/"
                    data-tooltip="谈谈Http和Https"
                    aria-label="FRÜHER: 谈谈Http和Https"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">FRÜHER</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2016/02/13/%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89UIViewController%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB/"
                    data-tooltip="创建自定义UIViewController过渡动画"
                    aria-label="NÄCHSTER: 创建自定义UIViewController过渡动画"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NÄCHSTER</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Teilen auf Facebook"
                    aria-label="Teilen auf Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Teilen auf Twitter"
                    aria-label="Teilen auf Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                    title="Teilen auf Google Plus"
                    aria-label="Teilen auf Google Plus"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                        aria-label="Teilen auf Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Teilen auf Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                        aria-label="Teilen auf Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Teilen auf Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://yoursite.com/2016/03/18/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
                        aria-label="Teilen auf Google Plus"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Teilen auf Google Plus</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">loannes</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/jquery.js"></script>


<script src="/assets/js/jquery.fancybox.js"></script>


<script src="/assets/js/thumbs.js"></script>


<script src="/assets/js/tranquilpeak.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
